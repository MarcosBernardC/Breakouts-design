import sys
import os
from pathlib import Path

# -----------------------------
#  Parámetros
# -----------------------------
FCSTD_STR = os.environ.get("FCSTD_FILE")
OUT_WRL_STR = os.environ.get("OUT_WRL_FILE")

if not FCSTD_STR or not OUT_WRL_STR:
    print("Uso: FCSTD_FILE=<ruta> OUT_WRL_FILE=<ruta> freecadcmd export_wrl.py")
    sys.exit(1)

import FreeCAD

# -----------------------------
#  Main
# -----------------------------
FCSTD = Path(FCSTD_STR).resolve()
OUT_WRL = Path(OUT_WRL_STR).resolve()

if not FCSTD.exists():
    print(f"❌ ERROR: No existe {FCSTD}")
    sys.exit(1)

print(f">>> Abriendo documento: {FCSTD}")
doc = FreeCAD.openDocument(str(FCSTD))

valid_objs = [
    obj for obj in doc.Objects
    if hasattr(obj, "Shape") and obj.Shape is not None and not obj.Shape.isNull()
]

if not valid_objs:
    print("❌ No hay objetos con shapes válidas para exportar.")
    sys.exit(1)

print(f">>> Exportando {len(valid_objs)} objeto(s) a {OUT_WRL}...")
OUT_WRL.parent.mkdir(parents=True, exist_ok=True)

# Asegurar que todos los objetos tienen colores
for obj in valid_objs:
    if not hasattr(obj, "Color"):
        print(f"⚠ {obj.Name} sin color, usando gris por defecto")
        obj.addProperty("App::PropertyColor", "Color", "Base", "Object color")
        obj.Color = (0.8, 0.8, 0.8)

# Generar VRML 2.0 manualmente
try:
    vrml_content = ["#VRML V2.0 utf8\n", "# Generated by FreeCAD for KiCad\n\n"]
    
    for obj in valid_objs:
        # Obtener color del objeto
        if hasattr(obj, "Color"):
            r, g, b = obj.Color[0], obj.Color[1], obj.Color[2]
        else:
            r, g, b = 0.8, 0.8, 0.8
        
        print(f"  → {obj.Name}: RGB({r:.2f}, {g:.2f}, {b:.2f})")
        
        # Tesselate shape
        shape = obj.Shape
        tessellation = shape.tessellate(0.1)  # Precisión 0.1mm
        vertices = tessellation[0]
        faces = tessellation[1]
        
        # Crear Shape node
        vrml_content.append(f"# Object: {obj.Name}\n")
        vrml_content.append("Shape {\n")
        vrml_content.append("  appearance Appearance {\n")
        vrml_content.append("    material Material {\n")
        vrml_content.append(f"      diffuseColor {r:.3f} {g:.3f} {b:.3f}\n")
        vrml_content.append("      specularColor 0.5 0.5 0.5\n")
        vrml_content.append("      emissiveColor 0.0 0.0 0.0\n")
        vrml_content.append("      ambientIntensity 0.2\n")
        vrml_content.append("      transparency 0.0\n")
        vrml_content.append("      shininess 0.2\n")
        vrml_content.append("    }\n")
        vrml_content.append("  }\n")
        vrml_content.append("  geometry IndexedFaceSet {\n")
        
        # Escribir coordenadas
        vrml_content.append("    coord Coordinate {\n")
        vrml_content.append("      point [\n")
        for v in vertices:
            vrml_content.append(f"        {v.x:.6f} {v.y:.6f} {v.z:.6f},\n")
        vrml_content.append("      ]\n")
        vrml_content.append("    }\n")
        
        # Escribir índices de caras
        vrml_content.append("    coordIndex [\n")
        for face in faces:
            vrml_content.append(f"      {face[0]}, {face[1]}, {face[2]}, -1,\n")
        vrml_content.append("    ]\n")
        
        vrml_content.append("    solid FALSE\n")
        vrml_content.append("  }\n")
        vrml_content.append("}\n\n")
    
    # Escribir archivo
    with open(OUT_WRL, 'w') as f:
        f.writelines(vrml_content)
    
    # Verificar archivo
    if OUT_WRL.exists():
        size = OUT_WRL.stat().st_size
        print(f"✔ WRL generado: {OUT_WRL}")
        print(f"  Tamaño: {size} bytes")
        print(f"  ✓ {len(valid_objs)} objetos con materiales")
    else:
        print("❌ No se creó el archivo WRL")
        sys.exit(1)
        
except Exception as e:
    print(f"❌ Error al exportar: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

try:
    FreeCAD.closeDocument(doc.Name)
except Exception as e:
    print(f"⚠ No se pudo cerrar documento: {e}")

print("✔ Exportación completa")